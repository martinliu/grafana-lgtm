x-versions:  # 镜像版本统一在此管理,便于后续独立升级
  prometheus: &prometheus_image prom/prometheus:v3.7.3
  loki:       &loki_image       grafana/loki:3.5.8
  tempo:      &tempo_image      grafana/tempo:2.9.0
  grafana:    &grafana_image    grafana/grafana:12.2.1
  alloy:      &alloy_image      grafana/alloy:v1.10.0

services:

  # 指标采集与查询（Prometheus）
  # - 暴露 9090；保留期 90 天（2160h）；数据目录持久化至命名卷
  prometheus:
    image: *prometheus_image
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro  # 外置 Prometheus 配置
      - prometheus-data:/prometheus                        # 持久化 TSDB 数据
    ports:
      - "9090:9090"
    restart: unless-stopped
    command: [
      "--config.file=/etc/prometheus/prometheus.yml",
      "--storage.tsdb.path=/prometheus",
      "--storage.tsdb.retention.time=2160h",
      "--web.enable-remote-write-receiver"
    ]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9090/-/ready > /dev/null 2>&1"]  # 依赖镜像自带 wget；无则可改为 curl
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # 日志存储（Loki）
  # - 暴露 3100；数据目录持久化；全局保留期在 loki-local-config.yaml 中配置（已设 90 天）
  loki:
    image: *loki_image
    container_name: loki
    user: "0:0"
    volumes:
      - ./loki-local-config.yaml:/etc/loki/local-config.yaml:ro
      - loki-data:/tmp/loki
    command:
      - -config.file=/etc/loki/local-config.yaml
      - -print-config-stderr
    ports:
      - "3100:3100"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3100/ready > /dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s



  # Trace 存储（Tempo）
  # - 暴露 3200（查询）；4317 仅供容器间通信（Alloy→Tempo）；数据目录持久化；保留期已设 90 天
  tempo:
    image: *tempo_image
    container_name: tempo
    user: "0:0"  # 以 root 运行，便于写入本地数据目录
    volumes:
      - ./tempo-local.yaml:/etc/tempo/tempo-local.yaml:ro  # 外置 Tempo 配置
      - tempo-data:/tmp/tempo                             # 持久化 Tempo 数据
    command: ["-config.file=/etc/tempo/tempo-local.yaml"]
    ports:
      - "3200:3200"   # 查询 HTTP 端口（对外暴露）
    expose:
      - "4317"        # OTLP gRPC 内部端口（仅供 Alloy 容器间通信，不暴露到宿主机）
    restart: unless-stopped

  # 可视化（Grafana）
  # - 暴露 3000；数据目录持久化；加载 custom.ini 与预置的数据源/看板
  grafana:
    image: *grafana_image
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin 
      - GF_SECURITY_ADMIN_PASSWORD=admin 

      # —— Grafana → Tempo ——（重要）
      - GF_TRACING_OPENTELEMETRY_OTLP_ADDRESS=tempo:4317   # gRPC，host:port；不要写 http://
      - GF_TRACING_OPENTELEMETRY_OTLP_INSECURE=true        # 单机 Demo 直连即可
      - GF_TRACING_OPENTELEMETRY_PROPAGATION=w3c           # 传播器（按需）
      - GF_TRACING_OPENTELEMETRY_SAMPLER=parentbased_traceidratio
      - GF_TRACING_OPENTELEMETRY_SAMPLER_PARAM=1.0         # 全量采样，便于演示

      - OTEL_SERVICE_NAME=grafana
    volumes:
      - ./grafana/custom.ini:/etc/grafana/grafana.ini:ro  # 覆盖默认 grafana.ini
      - grafana-data:/var/lib/grafana                    # 持久化用户、看板、插件等
      - ./grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro  # 预置数据源
      - ./grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro      # 预置看板配置
      - ./grafana/dashboards/:/var/lib/grafana/dashboards:ro                                 # 看板 JSON 目录
    ports:
      - "3000:3000"
    restart: unless-stopped
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_healthy
      tempo:
        condition: service_started  # tempo 未设置健康检查，采用 started 条件避免阻塞
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health > /dev/null 2>&1"]  # 健康检查
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # 宿主机 OS 指标采集（Node Exporter）
  # - 采集宿主机 CPU、内存、磁盘、网络等 OS 级别指标
  # - 暴露 9100 端口供 Alloy 抓取
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    restart: unless-stopped

  # 日志采集（Grafana Alloy）
  # - 自动发现所有 Docker 容器日志并推送到 Loki
  # - 采集 Prometheus 指标
  # - OTLP 接收：4317/4318 用于外部应用推送，内部通过容器网络转发到 Tempo
  alloy:
    image: *alloy_image
    container_name: alloy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro       # Docker 服务发现
      - /var/lib/docker/containers:/var/lib/docker/containers:ro  # 读取容器日志
      - ./alloy-config.yaml:/etc/alloy/config.yaml:ro     # Alloy 配置
      - alloy-data:/var/lib/alloy                         # 持久化位点数据


      # 为宿主机 OS 指标准备的挂载
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro

    ports:
      - "4317:4317"   # OTLP gRPC receiver（外部应用推送追踪）
      - "4318:4318"   # OTLP HTTP receiver（外部应用推送追踪）
      - "12345:12345" # Alloy UI 和指标端口
    command:
      - run
      - /etc/alloy/config.yaml
      - --server.http.listen-addr=0.0.0.0:12345
    depends_on:
      loki:
        condition: service_healthy
      prometheus:
        condition: service_healthy
      tempo:
        condition: service_started
    restart: unless-stopped


volumes:
  loki-data: {}         # Loki 数据卷
  tempo-data: {}        # Tempo 数据卷
  grafana-data: {}      # Grafana 数据卷
  prometheus-data: {}   # Prometheus 数据卷
  alloy-data: {}        # Alloy 采集位点卷
